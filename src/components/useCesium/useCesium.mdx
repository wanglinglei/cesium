import { Meta } from '@storybook/blocks';

<Meta title="Hooks/useCesium" />

# useCesium Hook

`useCesium` æ˜¯ä¸€ä¸ª Vue 3 ç»„åˆå¼å‡½æ•°ï¼ˆComposableï¼‰ï¼Œç”¨äºç®¡ç† Cesium Viewer çš„ç”Ÿå‘½å‘¨æœŸã€‚

## æ¦‚è¿°

è¿™ä¸ª hook æä¾›äº†ä¸€ç§ç®€å•çš„æ–¹å¼æ¥åœ¨ Vue ç»„ä»¶ä¸­åˆ›å»ºå’Œç®¡ç† Cesium ä¸‰ç»´åœ°çƒè§†å›¾ã€‚å®ƒè‡ªåŠ¨å¤„ç† Viewer çš„åˆå§‹åŒ–å’Œé”€æ¯ï¼Œç¡®ä¿èµ„æºæ­£ç¡®æ¸…ç†ã€‚

## ç‰¹æ€§

- ğŸŒ **å®Œæ•´çš„ä¸‰ç»´åœ°çƒè§†å›¾** - åŸºäº Cesium å¼•æ“
- ğŸ® **å†…ç½®ç›¸æœºæ§åˆ¶** - é¼ æ ‡æ‹–æ‹½ã€æ»šè½®ç¼©æ”¾
- âš™ï¸ **çµæ´»çš„é…ç½®é€‰é¡¹** - æ”¯æŒæ‰€æœ‰ Cesium Viewer é…ç½®
- ğŸ”„ **è‡ªåŠ¨ç”Ÿå‘½å‘¨æœŸç®¡ç†** - è‡ªåŠ¨æ¸…ç†èµ„æº
- ğŸ“¦ **æ”¯æŒå¤šå®ä¾‹** - å¯åœ¨åŒä¸€é¡µé¢åˆ›å»ºå¤šä¸ª Viewer

## API å‚è€ƒ

### è¿”å›å€¼

```typescript
interface UseCesiumReturn {
  viewer: Ref<Cesium.Viewer | null>; // Viewer å®ä¾‹çš„å“åº”å¼å¼•ç”¨
  initViewer: (props: UseCesiumProps) => void; // åˆå§‹åŒ–æ–¹æ³•
  destory: () => void; // é”€æ¯æ–¹æ³•
}
```

### initViewer å‚æ•°

```typescript
interface UseCesiumProps {
  containerId: string; // å®¹å™¨å…ƒç´ çš„ idï¼ˆå¿…éœ€ï¼Œå¿…é¡»å”¯ä¸€ï¼‰
  forceCreate?: boolean; // æ˜¯å¦å¼ºåˆ¶é‡æ–°åˆ›å»º viewer
  options?: Cesium.Viewer.ConstructorOptions; // Cesium Viewer é…ç½®é€‰é¡¹
  baseLayer?: Cesium.ImageryLayer; // è‡ªå®šä¹‰åŸºç¡€å›¾å±‚
}
```

#### å‚æ•°è¯´æ˜

<table>
  <thead>
    <tr>
      <th>å‚æ•°</th>
      <th>ç±»å‹</th>
      <th>å¿…éœ€</th>
      <th>é»˜è®¤å€¼</th>
      <th>è¯´æ˜</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>
        <code>containerId</code>
      </td>
      <td>
        <code>string</code>
      </td>
      <td>âœ…</td>
      <td>-</td>
      <td>DOM å®¹å™¨çš„ idï¼Œå¿…é¡»åœ¨é¡µé¢ä¸­å”¯ä¸€</td>
    </tr>
    <tr>
      <td>
        <code>forceCreate</code>
      </td>
      <td>
        <code>boolean</code>
      </td>
      <td>âŒ</td>
      <td>-</td>
      <td>æ˜¯å¦å¼ºåˆ¶é‡æ–°åˆ›å»º viewerï¼ˆä¼šé”€æ¯ç°æœ‰å®ä¾‹ï¼‰</td>
    </tr>
    <tr>
      <td>
        <code>options</code>
      </td>
      <td>
        <code>Cesium.Viewer.ConstructorOptions</code>
      </td>
      <td>âŒ</td>
      <td>-</td>
      <td>Cesium Viewer çš„é…ç½®é€‰é¡¹</td>
    </tr>
    <tr>
      <td>
        <code>baseLayer</code>
      </td>
      <td>
        <code>Cesium.ImageryLayer</code>
      </td>
      <td>âŒ</td>
      <td>-</td>
      <td>è‡ªå®šä¹‰åŸºç¡€å›¾å±‚ï¼ˆä¼šç§»é™¤é»˜è®¤å›¾å±‚ï¼‰</td>
    </tr>
  </tbody>
</table>

## åŸºç¡€ç”¨æ³•

### æœ€ç®€å•çš„ç¤ºä¾‹

```vue
<template>
  <div id="cesiumContainer" class="w-full h-screen"></div>
</template>

<script setup lang="ts">
import { useCesium } from '@/hooks/useCesium';

const { initViewer, destory } = useCesium();

onMounted(() => {
  initViewer({
    containerId: 'cesiumContainer',
    forceCreate: true,
  });
});

onBeforeUnmount(() => {
  destory();
});
</script>
```

### å¸¦è‡ªå®šä¹‰é…ç½®

```vue
<template>
  <div id="cesiumContainer" class="w-full h-screen"></div>
</template>

<script setup lang="ts">
import { useCesium } from '@/hooks/useCesium';
import * as Cesium from 'cesium';

const { initViewer, destory, viewer } = useCesium();

onMounted(() => {
  initViewer({
    containerId: 'cesiumContainer',
    forceCreate: true,
    options: {
      animation: false, // ç¦ç”¨åŠ¨ç”»æ§ä»¶
      timeline: false, // ç¦ç”¨æ—¶é—´è½´
      baseLayerPicker: false, // ç¦ç”¨å›¾å±‚é€‰æ‹©å™¨
      geocoder: false, // ç¦ç”¨åœ°ç†ç¼–ç æœç´¢
      sceneMode: Cesium.SceneMode.SCENE3D, // 3D æ¨¡å¼
    },
  });

  // åˆå§‹åŒ–åæ“ä½œ viewer
  nextTick(() => {
    if (viewer.value) {
      // è®¾ç½®åˆå§‹ç›¸æœºä½ç½®
      viewer.value.camera.setView({
        destination: Cesium.Cartesian3.fromDegrees(116.4, 39.9, 10000000),
      });
    }
  });
});

onBeforeUnmount(() => {
  destory();
});
</script>
```

### å“åº”å¼æ“ä½œ Viewer

```vue
<template>
  <div>
    <div id="cesiumContainer" class="w-full h-screen"></div>
    <button @click="flyToBeijing">é£åˆ°åŒ—äº¬</button>
    <button @click="flyToShanghai">é£åˆ°ä¸Šæµ·</button>
  </div>
</template>

<script setup lang="ts">
import { useCesium } from '@/hooks/useCesium';
import * as Cesium from 'cesium';

const { initViewer, destory, viewer } = useCesium();

onMounted(() => {
  initViewer({
    containerId: 'cesiumContainer',
    forceCreate: true,
  });
});

const flyToBeijing = () => {
  if (viewer.value) {
    viewer.value.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(116.4, 39.9, 10000000),
      duration: 2,
    });
  }
};

const flyToShanghai = () => {
  if (viewer.value) {
    viewer.value.camera.flyTo({
      destination: Cesium.Cartesian3.fromDegrees(121.5, 31.2, 10000000),
      duration: 2,
    });
  }
};

onBeforeUnmount(() => {
  destory();
});
</script>
```

## å¸¸ç”¨é…ç½®é€‰é¡¹

### æ§ä»¶é…ç½®

```typescript
const options = {
  // æ§ä»¶æ˜¾ç¤º/éšè—
  animation: false, // åŠ¨ç”»æ§ä»¶
  timeline: false, // æ—¶é—´è½´
  baseLayerPicker: false, // å›¾å±‚é€‰æ‹©å™¨
  geocoder: false, // åœ°ç†ç¼–ç æœç´¢
  homeButton: true, // ä¸»é¡µæŒ‰é’®
  sceneModePicker: true, // åœºæ™¯æ¨¡å¼é€‰æ‹©å™¨
  navigationHelpButton: false, // å¯¼èˆªå¸®åŠ©æŒ‰é’®
  fullscreenButton: true, // å…¨å±æŒ‰é’®
  vrButton: false, // VR æŒ‰é’®

  // ä¿¡ç”¨ä¿¡æ¯
  creditContainer: undefined, // ä¿¡ç”¨ä¿¡æ¯å®¹å™¨
  creditViewport: undefined, // ä¿¡ç”¨ä¿¡æ¯è§†å£
};
```

### åœºæ™¯é…ç½®

```typescript
const options = {
  // åœºæ™¯æ¨¡å¼
  sceneMode: Cesium.SceneMode.SCENE3D, // SCENE3D | SCENE2D | COLUMBUS_VIEW
  scene3DOnly: false, // æ˜¯å¦ä»…æ”¯æŒ 3D æ¨¡å¼

  // æ¸²æŸ“æ€§èƒ½
  requestRenderMode: false, // è¯·æ±‚æ¸²æŸ“æ¨¡å¼ï¼ˆæŒ‰éœ€æ¸²æŸ“ï¼‰
  maximumRenderTimeChange: Infinity, // æœ€å¤§æ¸²æŸ“æ—¶é—´å˜åŒ–

  // åœ°å½¢å’Œå½±åƒ
  terrainProvider: undefined, // åœ°å½¢æ•°æ®æä¾›è€…
  imageryProvider: undefined, // å½±åƒæ•°æ®æä¾›è€…

  // å¤©ç©ºç›’å’Œæ°›å›´
  skyBox: undefined, // å¤©ç©ºç›’
  skyAtmosphere: undefined, // å¤§æ°”æ•ˆæœ

  // é˜´å½±
  shadows: false, // æ˜¯å¦å¯ç”¨é˜´å½±
  terrainShadows: Cesium.ShadowMode.RECEIVE_ONLY, // åœ°å½¢é˜´å½±æ¨¡å¼
};
```

### å›¾å±‚é…ç½®

```typescript
const options = {
  baseLayer: Cesium.ImageryLayer.fromProviderAsync(
    Cesium.TileMapServiceImageryProvider.fromUrl(
      Cesium.buildModuleUrl('Assets/Textures/NaturalEarthII'),
    ),
  ),
  terrainProvider: await Cesium.CesiumTerrainProvider.fromIonAssetId(1),
};
```

## æ·»åŠ è‡ªå®šä¹‰å›¾å±‚

```vue
<script setup lang="ts">
import { useCesium } from '@/hooks/useCesium';
import * as Cesium from 'cesium';

const { initViewer, destory, viewer } = useCesium();

onMounted(() => {
  initViewer({
    containerId: 'cesiumContainer',
    forceCreate: true,
  });

  nextTick(() => {
    if (viewer.value) {
      // æ·»åŠ  TMS ç“¦ç‰‡å›¾å±‚
      const imageryProvider = new Cesium.UrlTemplateImageryProvider({
        url: 'https://example.com/tiles/{z}/{x}/{y}.png',
        credit: 'è‡ªå®šä¹‰å›¾å±‚',
      });
      viewer.value.imageryLayers.addImageryProvider(imageryProvider);

      // æ·»åŠ  WMS å›¾å±‚
      const wmsProvider = new Cesium.WebMapServiceImageryProvider({
        url: 'https://example.com/wms',
        layers: 'layer_name',
        parameters: {
          transparent: true,
          format: 'image/png',
        },
      });
      viewer.value.imageryLayers.addImageryProvider(wmsProvider);
    }
  });
});
</script>
```

## å¤šå®ä¾‹ä½¿ç”¨

å½“éœ€è¦åœ¨åŒä¸€é¡µé¢æ˜¾ç¤ºå¤šä¸ª Cesium è§†å›¾æ—¶ï¼š

```vue
<template>
  <div class="grid grid-cols-2 gap-4">
    <div id="cesium-viewer-1" class="h-96"></div>
    <div id="cesium-viewer-2" class="h-96"></div>
  </div>
</template>

<script setup lang="ts">
import { useCesium } from '@/hooks/useCesium';

// åˆ›å»ºä¸¤ä¸ªç‹¬ç«‹çš„ viewer å®ä¾‹
const viewer1 = useCesium();
const viewer2 = useCesium();

onMounted(() => {
  // åˆå§‹åŒ–ç¬¬ä¸€ä¸ª viewer
  viewer1.initViewer({
    containerId: 'cesium-viewer-1',
    forceCreate: true,
  });

  // åˆå§‹åŒ–ç¬¬äºŒä¸ª viewer
  viewer2.initViewer({
    containerId: 'cesium-viewer-2',
    forceCreate: true,
  });
});

onBeforeUnmount(() => {
  viewer1.destory();
  viewer2.destory();
});
</script>
```

## æ³¨æ„äº‹é¡¹

### âš ï¸ å®¹å™¨ ID å¿…é¡»å”¯ä¸€

```vue
<!-- âœ… æ­£ç¡® -->
<div id="cesium-viewer-1"></div>
<div id="cesium-viewer-2"></div>

<!-- âŒ é”™è¯¯ - ID é‡å¤ -->
<div id="cesiumContainer"></div>
<div id="cesiumContainer"></div>
```

### âš ï¸ ç¡®ä¿å®¹å™¨å…ƒç´ å­˜åœ¨

```vue
<script setup lang="ts">
const { initViewer } = useCesium();

onMounted(() => {
  // âœ… æ­£ç¡® - åœ¨ nextTick ä¸­åˆå§‹åŒ–ï¼Œç¡®ä¿ DOM å·²æ¸²æŸ“
  nextTick(() => {
    initViewer({ containerId: 'cesiumContainer' });
  });

  // âŒ é”™è¯¯ - DOM å¯èƒ½è¿˜æœªæ¸²æŸ“
  initViewer({ containerId: 'cesiumContainer' });
});
</script>
```

### âš ï¸ è®°å¾—æ¸…ç†èµ„æº

```vue
<script setup lang="ts">
const { initViewer, destory } = useCesium();

onMounted(() => {
  initViewer({ containerId: 'cesiumContainer' });
});

// âœ… æ­£ç¡® - ç»„ä»¶å¸è½½æ—¶æ¸…ç†
onBeforeUnmount(() => {
  destory();
});
</script>
```

### âš ï¸ é…ç½® Access Token

åœ¨ä½¿ç”¨ Cesium Ion æœåŠ¡å‰ï¼Œéœ€è¦é…ç½® Access Tokenï¼š

```bash
# .env æˆ– .env.local
VITE_CESIUM_ACCESS_TOKEN=your_cesium_ion_token_here
```

è·å– Tokenï¼šè®¿é—® [Cesium Ion](https://cesium.com/ion/signup) æ³¨å†Œè´¦å·å¹¶åˆ›å»º Tokenã€‚

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. å¯ç”¨è¯·æ±‚æ¸²æŸ“æ¨¡å¼

```typescript
initViewer({
  containerId: 'cesiumContainer',
  options: {
    requestRenderMode: true, // æŒ‰éœ€æ¸²æŸ“
    maximumRenderTimeChange: 0.5, // é™åˆ¶æ¸²æŸ“é¢‘ç‡
  },
});
```

### 2. ç¦ç”¨ä¸éœ€è¦çš„åŠŸèƒ½

```typescript
initViewer({
  containerId: 'cesiumContainer',
  options: {
    animation: false,
    timeline: false,
    shadows: false, // ç¦ç”¨é˜´å½±
    skyAtmosphere: false, // ç¦ç”¨å¤§æ°”æ•ˆæœï¼ˆå¦‚ä¸éœ€è¦ï¼‰
  },
});
```

### 3. æ§åˆ¶å›¾å±‚æ•°é‡

```typescript
// é™åˆ¶å›¾å±‚æ•°é‡ï¼Œç§»é™¤ä¸å¿…è¦çš„å›¾å±‚
if (viewer.value) {
  viewer.value.imageryLayers.removeAll();
  viewer.value.imageryLayers.addImageryProvider(myProvider);
}
```

## å¸¸è§é—®é¢˜

### Q: ä¸ºä»€ä¹ˆåˆå§‹åŒ–å viewer.value æ˜¯ nullï¼Ÿ

A: éœ€è¦ä½¿ç”¨ `nextTick` ç­‰å¾…åˆå§‹åŒ–å®Œæˆï¼š

```typescript
onMounted(() => {
  initViewer({ containerId: 'cesiumContainer' });

  nextTick(() => {
    console.log(viewer.value); // ç°åœ¨å¯ä»¥è®¿é—®äº†
  });
});
```

### Q: å¦‚ä½•å¤„ç† Cesium åŠ è½½é”™è¯¯ï¼Ÿ

A: ä½¿ç”¨ try-catch æ•è·é”™è¯¯ï¼š

```typescript
onMounted(() => {
  try {
    initViewer({ containerId: 'cesiumContainer' });
  } catch (error) {
    console.error('Cesium åˆå§‹åŒ–å¤±è´¥:', error);
    // æ˜¾ç¤ºé”™è¯¯æç¤ºç»™ç”¨æˆ·
  }
});
```

### Q: å¦‚ä½•åœ¨ TypeScript ä¸­ä½¿ç”¨ï¼Ÿ

A: å¯¼å…¥æ­£ç¡®çš„ç±»å‹å®šä¹‰ï¼š

```typescript
import { useCesium, type UseCesiumProps } from '@/hooks/useCesium';
import * as Cesium from 'cesium';

const { initViewer, viewer } = useCesium();

// viewer.value çš„ç±»å‹æ˜¯ Cesium.Viewer | null
if (viewer.value) {
  viewer.value.camera.flyTo({
    destination: Cesium.Cartesian3.fromDegrees(0, 0, 10000000),
  });
}
```

## ç›¸å…³èµ„æº

- [Cesium å®˜æ–¹æ–‡æ¡£](https://cesium.com/learn/)
- [Cesium API å‚è€ƒ](https://cesium.com/learn/cesiumjs/ref-doc/)
- [Cesium Sandcastle](https://sandcastle.cesium.com/) - åœ¨çº¿ç¤ºä¾‹
- [Cesium Community](https://community.cesium.com/) - ç¤¾åŒºè®ºå›

## æºç ä½ç½®

`src/hooks/useCesium.ts`
